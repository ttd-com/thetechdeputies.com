// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  name            String?
  role            Role      @default(USER)
  emailVerified   Boolean   @default(false) @map("email_verified")
  acuityClientId  String?   @map("acuity_client_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  sessions                  Session[]
  passwordResetTokens       PasswordResetToken[]
  emailVerificationTokens   EmailVerificationToken[]
  coursePurchases           CoursePurchase[]
  passwordChangeAudits      PasswordChangeAudit[]
  adminActions              AdminActionAudit[]
  passwordChangesBy         PasswordChangeAudit[] @relation("PasswordChanger")

  @@map("users")
}

enum Role {
  USER  @map("user")
  ADMIN @map("admin")
}

model Session {
  id        String   @id
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

model RateLimit {
  id          Int      @id @default(autoincrement())
  ipAddress   String   @map("ip_address")
  endpoint    String
  attempts    Int      @default(1)
  windowStart DateTime @default(now()) @map("window_start")

  @@unique([ipAddress, endpoint])
  @@map("rate_limits")
}

model Setting {
  key       String   @id
  value     String?
  encrypted Boolean  @default(false)
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model GiftCard {
  id              Int       @id @default(autoincrement())
  code            String    @unique
  originalAmount  Int       @map("original_amount")
  remainingAmount Int       @map("remaining_amount")
  purchaserEmail  String    @map("purchaser_email")
  purchaserName   String?   @map("purchaser_name")
  recipientEmail  String?   @map("recipient_email")
  recipientName   String?   @map("recipient_name")
  message         String?
  status          GiftCardStatus @default(ACTIVE)
  purchasedAt     DateTime  @default(now()) @map("purchased_at")
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  transactions GiftCardTransaction[]

  @@map("gift_cards")
}

enum GiftCardStatus {
  ACTIVE    @map("active")
  REDEEMED  @map("redeemed")
  EXPIRED   @map("expired")
  CANCELLED @map("cancelled")
}

model GiftCardTransaction {
  id          Int      @id @default(autoincrement())
  giftCardId  Int      @map("gift_card_id")
  amount      Int
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  @@map("gift_card_transactions")
}

model CoursePurchase {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  courseSlug   String    @map("course_slug")
  amountPaid   Int       @map("amount_paid")
  giftCardCode String?   @map("gift_card_code")
  status       CoursePurchaseStatus @default(ACTIVE)
  purchasedAt  DateTime  @default(now()) @map("purchased_at")
  expiresAt    DateTime? @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug])
  @@map("course_purchases")
}

enum CoursePurchaseStatus {
  ACTIVE   @map("active")
  REFUNDED @map("refunded")
  EXPIRED  @map("expired")
}

model PasswordChangeAudit {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  changedBy    Int      @map("changed_by")
  changeType   ChangeType @map("change_type")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  success      Boolean  @default(true)
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")

  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  changedByUser User @relation("PasswordChanger", fields: [changedBy], references: [id])

  @@map("password_change_audit")
}

enum ChangeType {
  SELF_CHANGE        @map("self_change")
  ADMIN_FORCE_CHANGE @map("admin_force_change")
  ADMIN_RESET        @map("admin_reset")
}

model AdminActionAudit {
  id           Int      @id @default(autoincrement())
  adminId      Int      @map("admin_id")
  action       String
  targetUserId Int?     @map("target_user_id")
  targetEmail  String?  @map("target_email")
  details      Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  success      Boolean  @default(true)
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")

  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_action_audit")
}

model EmailJob {
  id              Int       @id @default(autoincrement())
  messageId       String?   @unique @map("message_id")
  templateType    String    @map("template_type")
  recipientEmail  String    @map("recipient_email")
  recipientName   String?   @map("recipient_name")
  subject         String
  content         Json      // Template data
  status          EmailStatus @default(QUEUED)
  priority        Priority @default(NORMAL)
  scheduledAt     DateTime? @map("scheduled_at")
  sentAt          DateTime? @map("sent_at")
  deliveredAt     DateTime? @map("delivered_at")
  openedAt        DateTime? @map("opened_at")
  clickedAt       DateTime? @map("clicked_at")
  bouncedAt       DateTime? @map("bounced_at")
  complainedAt    DateTime? @map("complained_at")
  bounceReason    String?   @map("bounce_reason")
  complaintType  String?   @map("complaint_type")
  retryCount      Int       @default(0) @map("retry_count")
  maxRetries      Int       @default(3) @map("max_retries")
  lastError       String?   @map("last_error")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  deliveryEvents EmailDeliveryEvent[]

  @@map("email_jobs")
}

model EmailDeliveryEvent {
  id         Int      @id @default(autoincrement())
  emailJobId Int      @map("email_job_id")
  eventType  String   @map("event_type")
  timestamp  DateTime  @default(now())
  data       Json?    // Mailgun event data
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")

  emailJob EmailJob @relation(fields: [emailJobId], references: [id], onDelete: Cascade)

  @@map("email_delivery_events")
}

model EmailTemplate {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  subject     String
  htmlContent String    @map("html_content")
  textContent String?   @map("text_content")
  variables   Json?    // Template variable definitions
  isActive    Boolean   @default(true) @map("is_active")
  version     Int       @default(1) @map("version")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("email_templates")
}

model EmailSuppression {
  id           Int              @id @default(autoincrement())
  email        String           @unique
  type         SuppressionType
  reason       String?
  createdAt   DateTime         @default(now()) @map("created_at")
  expiresAt   DateTime?        @map("expires_at")

  @@map("email_suppressions")
}

enum EmailStatus {
  QUEUED      @map("queued")
  SENDING     @map("sending")
  SENT        @map("sent")
  DELIVERED   @map("delivered")
  OPENED      @map("opened")
  CLICKED     @map("clicked")
  BOUNCED     @map("bounced")
  COMPLAINED  @map("complained")
  FAILED      @map("failed")
  CANCELLED   @map("cancelled")
}

enum Priority {
  LOW         @map("low")
  NORMAL      @map("normal")
  HIGH        @map("high")
  CRITICAL    @map("critical")
}

enum SuppressionType {
  BOUNCE      @map("bounce")
  COMPLAINT   @map("complaint")
  UNSUBSCRIBE @map("unsubscribe")
  MANUAL      @map("manual")
}
