// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  name            String?
  role            Role      @default(USER)
  emailVerified   Boolean   @default(false) @map("email_verified")
  acuityClientId  String?   @map("acuity_client_id")
  stripeCustomerId String?  @map("stripe_customer_id")
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  sessions                  Session[]
  passwordResetTokens       PasswordResetToken[]
  emailVerificationTokens   EmailVerificationToken[]
  coursePurchases           CoursePurchase[]
  passwordChangeAudits      PasswordChangeAudit[]
  adminActions              AdminActionAudit[]
  passwordChangesBy         PasswordChangeAudit[] @relation("PasswordChanger")
  calendarEvents            CalendarEvent[]
  bookings                  Booking[]
  tickets                   Ticket[]
  ticketComments            TicketComment[]
  subscriptions             UserSubscription[]

  @@map("users")
}

enum Role {
  USER  @map("user")
  ADMIN @map("admin")
}

model Session {
  id        String   @id
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

model RateLimit {
  id          Int      @id @default(autoincrement())
  ipAddress   String   @map("ip_address")
  endpoint    String
  attempts    Int      @default(1)
  windowStart DateTime @default(now()) @map("window_start")

  @@unique([ipAddress, endpoint])
  @@map("rate_limits")
}

model Setting {
  key       String   @id
  value     String?
  encrypted Boolean  @default(false)
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model GiftCard {
  id              Int       @id @default(autoincrement())
  code            String    @unique
  originalAmount  Int       @map("original_amount")
  remainingAmount Int       @map("remaining_amount")
  purchaserEmail  String    @map("purchaser_email")
  purchaserName   String?   @map("purchaser_name")
  recipientEmail  String?   @map("recipient_email")
  recipientName   String?   @map("recipient_name")
  message         String?
  status          GiftCardStatus @default(ACTIVE)
  purchasedAt     DateTime  @default(now()) @map("purchased_at")
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  transactions GiftCardTransaction[]

  @@map("gift_cards")
}

enum GiftCardStatus {
  ACTIVE    @map("active")
  REDEEMED  @map("redeemed")
  EXPIRED   @map("expired")
  CANCELLED @map("cancelled")
}

model GiftCardTransaction {
  id          Int      @id @default(autoincrement())
  giftCardId  Int      @map("gift_card_id")
  amount      Int
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  @@map("gift_card_transactions")
}

model CoursePurchase {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  courseSlug   String    @map("course_slug")
  amountPaid   Int       @map("amount_paid")
  giftCardCode String?   @map("gift_card_code")
  status       CoursePurchaseStatus @default(ACTIVE)
  purchasedAt  DateTime  @default(now()) @map("purchased_at")
  expiresAt    DateTime? @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug])
  @@map("course_purchases")
}

enum CoursePurchaseStatus {
  ACTIVE   @map("active")
  REFUNDED @map("refunded")
  EXPIRED  @map("expired")
}

model PasswordChangeAudit {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  changedBy    Int      @map("changed_by")
  changeType   ChangeType @map("change_type")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  success      Boolean  @default(true)
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")

  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  changedByUser User @relation("PasswordChanger", fields: [changedBy], references: [id])

  @@map("password_change_audit")
}

enum ChangeType {
  SELF_CHANGE        @map("self_change")
  ADMIN_FORCE_CHANGE @map("admin_force_change")
  ADMIN_RESET        @map("admin_reset")
}

model AdminActionAudit {
  id           Int      @id @default(autoincrement())
  adminId      Int      @map("admin_id")
  action       String
  targetUserId Int?     @map("target_user_id")
  targetEmail  String?  @map("target_email")
  details      Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  success      Boolean  @default(true)
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")

  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_action_audit")
}

model EmailJob {
  id              Int       @id @default(autoincrement())
  messageId       String?   @unique @map("message_id")
  templateType    String    @map("template_type")
  recipientEmail  String    @map("recipient_email")
  recipientName   String?   @map("recipient_name")
  subject         String
  content         Json      // Template data
  status          EmailStatus @default(QUEUED)
  priority        Priority @default(NORMAL)
  scheduledAt     DateTime? @map("scheduled_at")
  sentAt          DateTime? @map("sent_at")
  deliveredAt     DateTime? @map("delivered_at")
  openedAt        DateTime? @map("opened_at")
  clickedAt       DateTime? @map("clicked_at")
  bouncedAt       DateTime? @map("bounced_at")
  complainedAt    DateTime? @map("complained_at")
  bounceReason    String?   @map("bounce_reason")
  complaintType  String?   @map("complaint_type")
  retryCount      Int       @default(0) @map("retry_count")
  maxRetries      Int       @default(3) @map("max_retries")
  lastError       String?   @map("last_error")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  deliveryEvents EmailDeliveryEvent[]

  @@map("email_jobs")
}

model EmailDeliveryEvent {
  id         Int      @id @default(autoincrement())
  emailJobId Int      @map("email_job_id")
  eventType  String   @map("event_type")
  timestamp  DateTime  @default(now())
  data       Json?    // Mailgun event data
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")

  emailJob EmailJob @relation(fields: [emailJobId], references: [id], onDelete: Cascade)

  @@map("email_delivery_events")
}

model EmailTemplate {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  subject     String
  htmlContent String    @map("html_content")
  textContent String?   @map("text_content")
  variables   Json?    // Template variable definitions
  isActive    Boolean   @default(true) @map("is_active")
  version     Int       @default(1) @map("version")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("email_templates")
}

model EmailSuppression {
  id           Int              @id @default(autoincrement())
  email        String           @unique
  type         SuppressionType
  reason       String?
  createdAt   DateTime         @default(now()) @map("created_at")
  expiresAt   DateTime?        @map("expires_at")

  @@map("email_suppressions")
}

enum EmailStatus {
  QUEUED      @map("queued")
  SENDING     @map("sending")
  SENT        @map("sent")
  DELIVERED   @map("delivered")
  OPENED      @map("opened")
  CLICKED     @map("clicked")
  BOUNCED     @map("bounced")
  COMPLAINED  @map("complained")
  FAILED      @map("failed")
  CANCELLED   @map("cancelled")
}

enum Priority {
  LOW         @map("low")
  NORMAL      @map("normal")
  HIGH        @map("high")
  CRITICAL    @map("critical")
}

enum SuppressionType {
  BOUNCE      @map("bounce")
  COMPLAINT   @map("complaint")
  UNSUBSCRIBE @map("unsubscribe")
  MANUAL      @map("manual")
}

model CalendarEvent {
  id           String    @id @default(cuid())
  title        String
  description  String?
  startTime    DateTime  @map("start_time")
  endTime      DateTime  @map("end_time")
  capacity     Int       @default(2)
  bookedCount  Int       @default(0) @map("booked_count")
  adminId      Int       @map("admin_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  admin        User      @relation(fields: [adminId], references: [id], onDelete: Restrict)
  bookings     Booking[]

  @@index([startTime])
  @@map("calendar_events")
}

model Booking {
  id           String        @id @default(cuid())
  userId       Int           @map("user_id")
  eventId      String        @map("event_id")
  bookedAt     DateTime      @default(now()) @map("booked_at")
  cancelledAt  DateTime?     @map("cancelled_at")
  status       BookingStatus @default(CONFIRMED)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  event        CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
  @@map("bookings")
}

model Ticket {
  id           String         @id @default(cuid())
  userId       Int            @map("user_id")
  projectId    String?        @map("project_id")
  title        String
  description  String?
  status       TicketStatus   @default(TODO)
  priority     TicketPriority @default(MEDIUM)
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  user         User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  comments     TicketComment[]

  @@map("tickets")
}

model TicketComment {
  id           String   @id @default(cuid())
  ticketId     String   @map("ticket_id")
  userId       Int      @map("user_id")
  content      String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  ticket       Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("ticket_comments")
}

enum BookingStatus {
  CONFIRMED @map("confirmed")
  CANCELLED @map("cancelled")
}

enum TicketStatus {
  TODO        @map("todo")
  IN_PROGRESS @map("in_progress")
  BLOCKED     @map("blocked")
  DONE        @map("done")
}

enum TicketPriority {
  LOW    @map("low")
  MEDIUM @map("medium")
  HIGH   @map("high")
  URGENT @map("urgent")
}

model Plan {
  id                Int       @id @default(autoincrement())
  name              String    @unique
  displayName       String    @map("display_name")
  description       String?
  priceInCents      Int       @map("price_in_cents")
  tier              PlanTier
  sessionLimit      Int       @map("session_limit")
  courseInclusion   CourseInclusion @map("course_inclusion")
  familySize        Int       @default(1) @map("family_size")
  supportTier       SupportTier @map("support_tier")
  featured          Boolean   @default(false)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  userSubscriptions UserSubscription[]

  @@map("plans")
}

model UserSubscription {
  id                    Int       @id @default(autoincrement())
  userId                Int       @map("user_id")
  planId                Int       @map("plan_id")
  stripeSubscriptionId  String?   @unique @map("stripe_subscription_id")
  status                SubscriptionStatus @default(ACTIVE)
  currentPeriodStart    DateTime  @map("current_period_start")
  currentPeriodEnd      DateTime  @map("current_period_end")
  cancelledAt           DateTime? @map("cancelled_at")
  sessionBookedThisMonth Int      @default(0) @map("session_booked_this_month")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                  Plan      @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@unique([userId, status])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("user_subscriptions")
}

enum PlanTier {
  BASIC    @map("basic")
  STANDARD @map("standard")
  PREMIUM  @map("premium")
}

enum CourseInclusion {
  NONE      @map("none")
  PARTIAL   @map("partial")
  FULL      @map("full")
}

enum SupportTier {
  EMAIL    @map("email")
  PRIORITY @map("priority")
  PREMIUM  @map("premium_24_7")
}

enum SubscriptionStatus {
  ACTIVE    @map("active")
  CANCELLED @map("cancelled")
  EXPIRED   @map("expired")
  PAST_DUE  @map("past_due")
}

